!function(e){var n,t={retryCount:5,focusThreashold:1500,keepAlive:3e4,tabTTL:6e4,workerUrl:"/tab_manager.js"},o="connection",r="activeTab",a="broadcast",i="dequeue",s="unload",u="queue",c="focus",d="echo",w="blur",l="ping",p="pong",g="sync",f={getNow:function(){return(new Date).getTime()},generateUID:function(e){var n=f.getNow(),t=Math.random().toString().slice(2,6);return e+"-"+t+n}},k={models:{workerLastSeen:0,reconnectCount:0,dequeue:{}},broadcast:function(e){e.type=e.type||a,b.postMessage(e)},echo:function(e){e.type=d,b.postMessage(e)},getTabId:function(){return n.selfId},isActiveTab:function(){return n.isActive},queue:{push:function(e,n,t){b.postMessage({type:u,queueItem:n,queueName:e,keepLast:t})},pull:function(e,t){var o=f.generateUID(e);b.postMessage({type:i,queueName:e,requestId:o}),n.dequeue[o]={callback:t,timeStamp:f.getNow()}}},hasFocus:function(){return document.hasFocus()}},b={init:function(){n=k.models,b.register(),b.bindWindowEvents(),b.periodicals.keepAlive()},register:function(){window.worker?(window.worker.port.close(),window.worker=new SharedWorker(t.workerUrl)):window.worker=new SharedWorker(t.workerUrl),window.worker.port.start(),window.worker.port.onmessage=b.onIncoming},setTabId:function(e){n.selfId=e},setActiveTab:function(e){e&&(n.isActive=e===k.getTabId())},onIncoming:function(e){var t=e.data;if(!e.data.target||e.data.target==k.getTabId())switch(n.workerLastSeen=f.getNow(),t.type){case o:b.onAcknowledge(t);break;case r:b.setActiveTab(t.id);break;case l:b.pingPong(l);break;case g:b.onSync(t);break;case i:b.dequeue(t)}},postMessage:function(e){e.type&&(_.assign(e,{tabId:k.getTabId()}),window.worker&&window.worker.port.postMessage(e))},onAcknowledge:function(e){b.setTabId(e.tabId),n.reconnectCount=0,Fiverr._syncState({all:!0})},onSync:function(e){(window.fNotifications&&e.all||e.pinned)&&fNotifications.updateCounter("local")},pingPong:function(e){var n=e&&e===l?p:l;b.postMessage({type:n,hasFocus:k.hasFocus(),url:location.href})},dequeue:function(e){if(e.requestId&&e.queueItem&&n.dequeue[e.requestId]){var t=e.requestId;"function"==typeof n.dequeue[t].callback&&n.dequeue[t].callback(e.queueItem),delete n.dequeue[t]}},periodicals:{keepAlive:function(){var e=f.getNow();return n.workerLastSeen&&e-n.workerLastSeen>=t.tabTTL?(n.workerLastSeen=0,setTimeout(b.periodicals.keepAlive,t.keepAlive),b.register()):!n.workerLastSeen&&n.reconnectCount>=t.retryCount?void n.reconnectCount++:(setTimeout(b.periodicals.keepAlive,t.keepAlive),void b.pingPong())}},bindWindowEvents:function(){var n=e(window),o=c+" "+w+" "+s;n.on(o,function(e){b.postMessage({type:e.type}),e.type===c&&setTimeout(function(){k.hasFocus()&&window.callOnFocus&&window.callOnFocus.length&&window.callOnFocus.forEach(function(e){e()})},t.focusThreashold)})}};window.fTabManager=k;var v="SharedWorker"in window;v&&b.init()}(jQuery);